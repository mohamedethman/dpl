<div class="spinner-wrapper" *ngIf="pageLoading">
  <div class="spinner"></div>
</div>

<div class="auth-container">
  <div class="auth-header">
    <div class="government-banner">
      <div class="header-left-content">
        <img src="assets/images/logo_rim.png" alt="Logo" class="logo-image" />
        <div class="government-text">
          <div class="government-title">
            RÉPUBLIQUE ISLAMIQUE DE MAURITANIE<br />
            <strong>Honneur - Fraternité - Justice</strong>
          </div>
          <div class="ministry-name">Ministère de la Santé</div>
          <div class="ministry-name">PNEM</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row w-100 mx-0 auth-page">
    <div class="col-lg-12 mx-auto">
      <div class="auth-card-container">
        <div class="auth-card">
          <div class="spinner-wrapper" *ngIf="loading">
            <div class="spinner"></div>
          </div>

          <div *ngIf="!loading">
            <div class="auth-logo">
              <img
                src="assets/images/regist.png"
                alt="Logo"
                class="logo-image"
              />
              <h3 class="text-center mt-3">Inscription Laboratoire</h3>
            </div>

            <form
              class="auth-form"
              #registrationForm="ngForm"
              (ngSubmit)="openOtpModal()"
            >
              <!-- 1. Informations de connexion -->
              <div class="form-section">
                <h4 class="section-title">
                  <i class="fas fa-user-lock me-2"></i>1. Informations de
                  connexion
                </h4>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="login">Choisir login</label>
                      <div class="input-with-icon">
                        <i class="fas fa-user"></i>
                        <input
                          type="text"
                          id="login"
                          class="form-control"
                          placeholder="Saisir le login"
                          name="login"
                          [(ngModel)]="laboratoire.login"
                          required
                        />
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="password">Mot de passe</label>
                      <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input
                          type="password"
                          id="password"
                          class="form-control"
                          placeholder="Saisir le mot de passe"
                          name="password"
                          [(ngModel)]="laboratoire.password"
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="repeatPassword"
                        >Répéter le mot de passe</label
                      >
                      <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input
                          type="password"
                          id="repeatPassword"
                          class="form-control"
                          placeholder="Répéter le mot de passe"
                          name="repeatPassword"
                          [(ngModel)]="repeatPassword"
                          required
                          (input)="checkPasswords()"
                        />
                      </div>
                      <small *ngIf="passwordMismatch" class="text-danger"
                        >Les mots de passe ne correspondent pas</small
                      >
                    </div>
                  </div>
                </div>
              </div>

              <!-- 2. Informations générales sur le laboratoire -->
              <div class="form-section">
                <h4 class="section-title">
                  <i class="fas fa-flask me-2"></i>2. Informations générales sur
                  le laboratoire
                </h4>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="nom">Nom du laboratoire</label>
                      <div class="input-with-icon">
                        <i class="fas fa-building"></i>
                        <input
                          type="text"
                          id="nom"
                          class="form-control"
                          placeholder="Saisir le nom du laboratoire"
                          name="nom"
                          [(ngModel)]="laboratoire.nom"
                          required
                        />
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="pays">Pays</label>
                      <div class="input-with-icon">
                        <i class="fas fa-globe"></i>
                        <input
                          type="text"
                          id="pays"
                          class="form-control"
                          placeholder="Saisir le pays"
                          name="pays"
                          [(ngModel)]="laboratoire.pays"
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="adresse">Adresse</label>
                      <div class="input-with-icon">
                        <i class="fas fa-map-marker-alt"></i>
                        <input
                          type="text"
                          id="adresse"
                          class="form-control"
                          placeholder="Saisir l'adresse complète"
                          name="adresse"
                          [(ngModel)]="laboratoire.adresse"
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 3. Informations de contact -->
              <div class="form-section">
                <h4 class="section-title">
                  <i class="fas fa-address-book me-2"></i>3. Informations de
                  contact
                </h4>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="telephone">Téléphone</label>
                      <div class="input-with-icon">
                        <i class="fas fa-phone"></i>
                        <input
                          type="text"
                          id="telephone"
                          class="form-control"
                          placeholder="Saisir le téléphone"
                          name="telephone"
                          [(ngModel)]="laboratoire.telephone"
                          required
                          pattern="[0-9]{8,15}"
                          #telephoneInput="ngModel"
                        />
                      </div>
                      <small
                        *ngIf="telephoneInput.invalid && telephoneInput.touched"
                        class="text-danger"
                      >
                        Numéro de téléphone invalide (8-15 chiffres)
                      </small>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="email">Email</label>
                      <div class="input-with-icon">
                        <i class="fas fa-envelope"></i>
                        <input
                          type="email"
                          id="email"
                          class="form-control"
                          placeholder="Saisir l'email"
                          name="email"
                          [(ngModel)]="laboratoire.email"
                          required
                          email
                          #emailInput="ngModel"
                        />
                      </div>
                      <small
                        *ngIf="emailInput.invalid && emailInput.touched"
                        class="text-danger"
                      >
                        Email invalide
                      </small>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="contactPrincipal">Contact principal</label>
                      <div class="input-with-icon">
                        <i class="fas fa-user-tie"></i>
                        <input
                          type="text"
                          id="contactPrincipal"
                          class="form-control"
                          placeholder="Saisir le contact principal"
                          name="contactPrincipal"
                          [(ngModel)]="laboratoire.contactPrincipal"
                          required
                        />
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="siteWeb">Site Web</label>
                      <div class="input-with-icon">
                        <i class="fas fa-globe"></i>
                        <input
                          type="text"
                          id="siteWeb"
                          class="form-control"
                          placeholder="Saisir le site web"
                          name="siteWeb"
                          [(ngModel)]="laboratoire.siteWeb"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 4. Pièce jointe -->
              <div class="form-section">
                <h4 class="section-title">
                  <i class="fas fa-paperclip me-2"></i>4. Pièce jointe
                </h4>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group required">
                      <label for="documentsAgrement"
                        >Documents d'agrément</label
                      >
                      <div class="input-with-icon">
                        <i class="fas fa-file-upload"></i>
                        <input
                          type="file"
                          id="documentsAgrement"
                          class="form-control"
                          (change)="onFileChange($event)"
                          accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                          #fileInput
                          required
                        />
                      </div>
                      <small class="text-muted"
                        >Formats acceptés: PDF, DOC, JPG, PNG</small
                      >
                      <small
                        *ngIf="fileRequiredError"
                        class="text-danger d-block"
                        >Les documents d'agrément sont obligatoires</small
                      >
                    </div>
                  </div>
                </div>
              </div>

              <!-- Submit Button -->
              <div class="form-actions text-center mt-4">
                <button
                  type="submit"
                  class="btn btn-primary btn-lg"
                  [disabled]="passwordMismatch || registrationForm.invalid"
                >
                  <i class="fas fa-user-plus me-2"></i> S'inscrire
                </button>
              </div>

              <!-- Login Link -->
              <div class="text-center mt-4">
                <p class="login-prompt">
                  Vous avez déjà un compte?
                  <a routerLink="/login" class="login-link">Se connecter</a>
                </p>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="auth-footer">
    <p>
      Copyright © 2025
      <a href="#" target="_blank">Ministère de la Santé</a>. Tous les droits
      sont réservés
    </p>
  </div>
</div>

<!-- OTP Verification Modal -->

<div
  #otpModal
  class="modal fade"
  id="otpModal"
  tabindex="-1"
  aria-labelledby="otpModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div
        class="modal-header text-white"
        style="background-color: #00a95c !important"
      >
        <h5 class="modal-title" id="otpModalLabel">
          <i class="fas fa-shield-alt me-2"></i>Vérification d'email
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center mb-4">
          <i
            class="fas fa-envelope-circle-check"
            style="font-size: 3rem; color: #00a95c"
          ></i>
          <h5 class="mt-3">Vérification requise</h5>
          <p class="mb-0">Un code de vérification a été envoyé à:</p>
          <p class="fw-bold">{{ laboratoire.email }}</p>
          <p>
            Ce code expirera dans
            <span class="text-danger">{{
              otpResendCountdown | timeFormat
            }}</span>
          </p>
        </div>

        <!-- 6-digit OTP Input -->
        <div class="form-group mb-4">
          <label class="form-label">Code de vérification (6 chiffres)*</label>
          <div class="d-flex justify-content-center gap-3">
            <input
              #otpInput0
              type="text"
              class="form-control text-center otp-digit"
              maxlength="1"
              [(ngModel)]="otpDigits[0]"
              name="otp0"
              (input)="onOtpChange(0, $event)"
              (keydown)="onOtpKeyDown(0, $event)"
              autofocus
            />

            <input
              #otpInput1
              type="text"
              class="form-control text-center otp-digit"
              maxlength="1"
              [(ngModel)]="otpDigits[1]"
              name="otp1"
              (input)="onOtpChange(1, $event)"
              (keydown)="onOtpKeyDown(1, $event)"
            />

            <input
              #otpInput2
              type="text"
              class="form-control text-center otp-digit"
              maxlength="1"
              [(ngModel)]="otpDigits[2]"
              name="otp2"
              (input)="onOtpChange(2, $event)"
              (keydown)="onOtpKeyDown(2, $event)"
            />

            <input
              #otpInput3
              type="text"
              class="form-control text-center otp-digit"
              maxlength="1"
              [(ngModel)]="otpDigits[3]"
              name="otp3"
              (input)="onOtpChange(3, $event)"
              (keydown)="onOtpKeyDown(3, $event)"
            />
            <input
              #otpInput4
              type="text"
              class="form-control text-center otp-digit"
              maxlength="1"
              [(ngModel)]="otpDigits[4]"
              name="otp4"
              (input)="onOtpChange(4, $event)"
              (keydown)="onOtpKeyDown(4, $event)"
            />
            <input
              #otpInput5
              type="text"
              class="form-control text-center otp-digit"
              maxlength="1"
              [(ngModel)]="otpDigits[5]"
              name="otp5"
              (input)="onOtpChange(5, $event)"
              (keydown)="onOtpKeyDown(5, $event)"
            />
          </div>
          <small *ngIf="otpError" class="text-danger d-block text-center mt-2"
            >Code incorrect ou expiré</small
          >
        </div>

        <div class="d-flex justify-content-between align-items-center">
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="resendOtp()"
            [disabled]="otpResendDisabled"
          >
            <i class="fas fa-sync-alt me-2"></i>
            Renvoyer le code
            <span *ngIf="otpResendCountdown > 0"
              >({{ otpResendCountdown | timeFormat }})</span
            >
          </button>

          <button
            type="button"
            class="btn btn-primary"
            (click)="verifyOtp()"
            [disabled]="!isOtpComplete()"
          >
            <i class="fas fa-check-circle me-2"></i> Vérifier
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
